---
date: '2009-03-27T12:13:00.000-07:00'
description: ''
published: true
slug: 2009-03-linq-to-sql-roundtrips-sql-trace
tags:
- .Net
- http://schemas.google.com/blogger/2008/kind#post
- SQL Origami
- legacy-blogger
time_to_read: 5
title: 'LINQ to SQL Roundtrips: SQL Trace'
---

*This was originally posted on blogger [here](https://techshorts.blogspot.com/2009/03/linq-to-sql-roundtrips-sql-trace.html)*.

I was looking into reducing the number of database round trips that LINQ to SQL took and found an article by <a href="http://davidhayden.com/blog/dave/archive/2007/08/05/LINQToSQLPerformanceTradeoffsLessDatabaseRoundtripsButDuplicatedData.aspx" target="_blank" title="David Hayden">David Hayden</a> that fit the bill.  I wanted to see what was actually happening so I slapped together a simple demo.<br /><br />Using the Pubs database I created a console app, added the LINQ to SQL classes then created a simple repository class:<br /><br /><div><pre style="margin: 0px;"><span style="color: blue;">public </span><span style="color: blue;">class </span><span style="color: rgb(43, 145, 175);">AuthorRepository</span></pre><pre style="margin: 0px;">{</pre><pre style="margin: 0px;">    <span style="color: blue;">public</span><span style="color: rgb(43, 145, 175);"> author</span> GetAuthorWithTitles(<span style="color: blue;">string</span> authorId)</pre><pre style="margin: 0px;">    {</pre><pre style="margin: 0px;">        <span style="color: blue;">var</span> db = <span style="color: blue;">new </span><span style="color: rgb(43, 145, 175);">PubsDataClassesDataContext</span>();</pre><pre style="margin: 0px;">        <span style="color: blue;">return</span> db.authors.FirstOrDefault(a =&gt; a.au_id == authorId);</pre><pre style="margin: 0px;">    }</pre><pre style="margin: 0px;"> </pre><pre style="margin: 0px;">    <span style="color: blue;">public </span><span style="color: rgb(43, 145, 175);">author</span> GetAuthorWithTitlesWithUsing(<span style="color: blue;">string</span> authorId)</pre><pre style="margin: 0px;">    {</pre><pre style="margin: 0px;">        <span style="color: blue;">using</span> (<span style="color: blue;">var</span> db = <span style="color: blue;">new </span><span style="color: rgb(43, 145, 175);">PubsDataClassesDataContext</span>())</pre><pre style="margin: 0px;">            <span style="color: blue;">return</span> db.authors.FirstOrDefault(a =&gt; a.au_id == authorId);</pre><pre style="margin: 0px;">    }</pre><pre style="margin: 0px;"> </pre><pre style="margin: 0px;">    <span style="color: blue;">public </span><span style="color: rgb(43, 145, 175);">author</span> GetAuthorWithTitlesPrefecth(<span style="color: blue;">string</span> authorId)</pre><pre style="margin: 0px;">    {</pre><pre style="margin: 0px;">        <span style="color: blue;">using</span> (<span style="color: blue;">var</span> db = <span style="color: blue;">new</span><span style="color: rgb(43, 145, 175);"> PubsDataClassesDataContext</span>())</pre><pre style="margin: 0px;">        {</pre><pre style="margin: 0px;">            <span style="color: blue;">var</span> options = <span style="color: blue;">new </span><span style="color: rgb(43, 145, 175);">DataLoadOptions</span>();</pre><pre style="margin: 0px;">            options.LoadWith&lt;<span style="color: rgb(43, 145, 175);">author</span>&gt;(a =&gt; a.titleauthors);</pre><pre style="margin: 0px;">            options.LoadWith&lt;<span style="color: rgb(43, 145, 175);">titleauthor</span>&gt;(ta =&gt; ta.title);</pre><pre style="margin: 0px;"> </pre><pre style="margin: 0px;">            db.LoadOptions = options;</pre><pre style="margin: 0px;">            <span style="color: blue;">return</span> db.authors.FirstOrDefault(a =&gt; a.au_id == authorId);</pre><pre style="margin: 0px;">        }</pre><pre style="margin: 0px;">    }</pre><pre style="margin: 0px;">}</pre></div><br />I created a simple method to dump the author and titles:<br /><br /><div><pre style="margin: 0px;"><span style="color: blue;">class </span><span style="color: rgb(43, 145, 175);">Program</span></pre><pre style="margin: 0px;">{</pre><pre style="margin: 0px;">    <span style="color: blue;">static </span><span style="color: blue;">void</span> Main(<span style="color: blue;">string</span>[] args)</pre><pre style="margin: 0px;">    {</pre><pre style="margin: 0px;">        <span style="color: blue;">var</span> repo = <span style="color: blue;">new</span><span style="color: rgb(43, 145, 175);"> AuthorRepository</span>();</pre><pre style="margin: 0px;"> </pre><pre style="margin: 0px;">        DumpAuthorToConsole(</pre><pre style="margin: 0px;">            repo.GetAuthorWithTitles(<span style="color: rgb(163, 21, 21);">"998-72-3567"</span>)</pre><pre style="margin: 0px;">            , <span style="color: rgb(163, 21, 21);">"Authors without prefetch and without using statement"</span>);</pre><pre style="margin: 0px;"> </pre><pre style="margin: 0px;">        DumpAuthorToConsole(</pre><pre style="margin: 0px;">            repo.GetAuthorWithTitlesWithUsing(<span style="color: rgb(163, 21, 21);">"998-72-3567"</span>)</pre><pre style="margin: 0px;">            , <span style="color: rgb(163, 21, 21);">"Authors without prefetch and but with using statement"</span>);</pre><pre style="margin: 0px;"> </pre><pre style="margin: 0px;">        DumpAuthorToConsole(</pre><pre style="margin: 0px;">            repo.GetAuthorWithTitlesPrefecth(<span style="color: rgb(163, 21, 21);">"998-72-3567"</span>)</pre><pre style="margin: 0px;">            , <span style="color: rgb(163, 21, 21);">"Authors with prefetch and with using statement"</span>);</pre><pre style="margin: 0px;">    }</pre><pre style="margin: 0px;"> </pre><pre style="margin: 0px;">    <span style="color: blue;">private</span><span style="color: blue;"> static </span><span style="color: blue;">void</span> DumpAuthorToConsole(<span style="color: rgb(43, 145, 175);">author</span> author, <span style="color: blue;">string</span> message)</pre><pre style="margin: 0px;">    {</pre><pre style="margin: 0px;">        <span style="color: rgb(43, 145, 175);">Console</span>.WriteLine();</pre><pre style="margin: 0px;">        <span style="color: rgb(43, 145, 175);">Console</span>.WriteLine(<span style="color: blue;">new </span><span style="color: blue;">string</span>(<span style="color: rgb(163, 21, 21);">'-'</span>, 50));</pre><pre style="margin: 0px;">        <span style="color: rgb(43, 145, 175);">Console</span>.WriteLine(message);</pre><pre style="margin: 0px;"> </pre><pre style="margin: 0px;">        <span style="color: blue;">try</span></pre><pre style="margin: 0px;">        {</pre><pre style="margin: 0px;">            <span style="color: rgb(43, 145, 175);">Console</span>.WriteLine(<span style="color: rgb(163, 21, 21);">"Author Name: {0} {1}"</span>, author.au_fname, author.au_lname);</pre><pre style="margin: 0px;">            <span style="color: rgb(43, 145, 175);">Console</span>.WriteLine(<span style="color: rgb(163, 21, 21);">"Count of Titles: {0}"</span>, author.titleauthors.Count);</pre><pre style="margin: 0px;"> </pre><pre style="margin: 0px;">            <span style="color: blue;">foreach</span> (<span style="color: blue;">var</span> titleauthor <span style="color: blue;">in</span> author.titleauthors)</pre><pre style="margin: 0px;">                <span style="color: rgb(43, 145, 175);">Console</span>.WriteLine(<span style="color: rgb(163, 21, 21);">"\tBook Title: {0}"</span>, titleauthor.title.title1);</pre><pre style="margin: 0px;">        }</pre><pre style="margin: 0px;">        <span style="color: blue;">catch</span> (<span style="color: rgb(43, 145, 175);">Exception</span> e)</pre><pre style="margin: 0px;">        {</pre><pre style="margin: 0px;">            <span style="color: rgb(43, 145, 175);">Console</span>.WriteLine(<span style="color: rgb(163, 21, 21);">"&gt;&gt;&gt; FAIL! &lt;&lt;&lt;"</span>);</pre><pre style="margin: 0px;">            <span style="color: rgb(43, 145, 175);">Console</span>.WriteLine(e.Message);</pre><pre style="margin: 0px;">        }</pre><pre style="margin: 0px;">    }</pre><pre style="margin: 0px;">}</pre></div><br /><br />>I did cheat and added some titles to the chosen author just so I could have at least five titles returned.  The results are:<br /><br /><div style="margin-left: 40px; font-family: courier new,courier,monospace;">--------------------------------------------------<br />Authors without prefetch and without using statement<br />Author Name: Albert Ringer<br />Count of Titles: 5<br /> Book Title: Silicon Valley Gastronomic Treats<br /> Book Title: Secrets of Silicon Valley<br /> Book Title: Computer Phobic AND Non-Phobic Individuals: Behavior Variations<br /> Book Title: Is Anger the Enemy?<br /> Book Title: Life Without Fear<br /><br />--------------------------------------------------<br />Authors without prefetch and but with using statement<br />Author Name: Albert Ringer<br />&gt;&gt;&gt; FAIL! &lt;&lt;&lt;<br />Cannot access a disposed object.<br />Object name: 'DataContext accessed after Dispose.'.<br /><br />--------------------------------------------------<br />Authors with prefetch and with using statement<br />Author Name: Albert Ringer<br />Count of Titles: 5<br /> Book Title: Silicon Valley Gastronomic Treats<br /> Book Title: Secrets of Silicon Valley<br /> Book Title: Computer Phobic AND Non-Phobic Individuals: Behavior Variations<br /> Book Title: Is Anger the Enemy?<br /> Book Title: Life Without Fear<br />Press any key to continue . . .<br /></div><br />Notice that there are three cases above, with one failing.<br /><h2>What are we looking at?</h2><h3>Case 1: Authors without prefetch and without using statement</h3>This is the GetAuthorsWithTitles() method, it simple creates the DataContext and returns the author object.  Simple, clean and easy, but not very effecient.<br /><br />First note that the DataContext was not disposed so it is still lingering out there, waiting to be garbage collected.  The SQL trace looks like this:<br /><br /><a href="http://1.bp.blogspot.com/_b0eO9UeA-Ig/Sc0nXJzJTMI/AAAAAAAAAOI/9yaYRCKL1FE/s1600-h/case01.png"><img alt="" border="0" id="BLOGGER_PHOTO_ID_5317950013715336386" src="http://1.bp.blogspot.com/_b0eO9UeA-Ig/Sc0nXJzJTMI/AAAAAAAAAOI/9yaYRCKL1FE/s400/case01.png" style="cursor: pointer; width: 623px; height: 524px;" /></a><br /><br /><br />The first sp_executesql loads the author, the second loads all the titleauthor rows for the author and the rest select each individual title from the titles table.  So for one author, a count of his titles and a list of each title requiers seven round trips to the database.  Notice that each time a round trip is made a connection has to be created.<br /><br /><h3>Case 2: Authors without prefetch and but with using statement</h3>This is the GetAuthorsWithTitleWithUsing() method, which is the same as before in that it simple creates a DataContext and returns the author but then properly disposes of the context.  This fails to return the count of the titles and the individual titles because the lazy loading cannot happen on a disposed context so an exception is thrown in this case.<br /><br />The trace only shows one sp_executesql:<br /><a href="http://1.bp.blogspot.com/_b0eO9UeA-Ig/Sc0nfX4oCtI/AAAAAAAAAOQ/bxntcYbttEE/s1600-h/case02.png"><img alt="" border="0" id="BLOGGER_PHOTO_ID_5317950154935372498" src="http://1.bp.blogspot.com/_b0eO9UeA-Ig/Sc0nfX4oCtI/AAAAAAAAAOQ/bxntcYbttEE/s400/case02.png" style="cursor: pointer; width: 568px; height: 171px;" /></a><br /><br /><h3>Case 3: Authors with prefetch and with using statement</h3>In this case we use the DataLoadOptions to tell LINQ to load the titleauthors with the author and to load the titles with the titleauthors.  The DataContext is disposed after returning the author.<br /><br /><a href="http://2.bp.blogspot.com/_b0eO9UeA-Ig/Sc0ni56_cPI/AAAAAAAAAOY/f6E5Beh9RSQ/s1600-h/case03.png"><img alt="" border="0" id="BLOGGER_PHOTO_ID_5317950215611707634" src="http://2.bp.blogspot.com/_b0eO9UeA-Ig/Sc0ni56_cPI/AAAAAAAAAOY/f6E5Beh9RSQ/s400/case03.png" style="cursor: pointer; width: 630px; height: 200px;" /></a><br /><br /><br />Notice that two sp_executesql's were executed and that both were on the same connection.  The first sql returned the author:<br /><br /><div style="margin-left: 40px; font-family: courier new,courier,monospace;">exec sp_executesql N'SELECT TOP (1) [t0].[au_id], [t0].[au_lname], [t0].[au_fname], [t0].[phone], [t0].[address], [t0].[city], [t0].[state], [t0].[zip], [t0].[contract]<br />FROM [dbo].[authors] AS [t0]<br />WHERE [t0].[au_id] = @p0',N'@p0 varchar(11)',@p0='998-72-3567'<br /></div><br />the second returned the titleauthor and titles:<br /><br /><div style="margin-left: 40px; font-family: courier new,courier,monospace;">exec sp_executesql N'SELECT [t0].[au_id], [t0].[title_id], [t0].[au_ord], [t0].[royaltyper], [t1].[title_id] AS [title_id2], [t1].[title] AS [title1], [t1].[type], [t1].[pub_id], [t1].[price], [t1].[advance], [t1].[royalty],<br />[t1].[ytd_sales], [t1].[notes], [t1].[pubdate]<br />FROM [dbo].[titleauthor] AS [t0]<br />INNER JOIN [dbo].[titles] AS [t1] ON [t1].[title_id] = [t0].[title_id]<br />WHERE [t0].[au_id] = @x1',N'@x1 varchar(11)',@x1='998-72-3567'<br /></div><br /><h2>Leasons Learned</h2>First beware of disposing the DataContext when you want to LazyLoad entities.  If you are going to do this then come up with a way to properly dispose of the context.<br /><br />Second round trips to the database can be reduced by using the DataLoadOptions.  This is not a guaranty of better performance but it is a step in the right direction.